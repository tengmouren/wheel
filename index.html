<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>è½¬ç›˜æŠ½å¥–</title>
    <style>
        :root {
            --size: 320px;
        }

        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
            background: radial-gradient(circle at top, #fff2f7, #f6f7ff);
            color: #222;
        }

        .wrap {
            width: min(92vw, 420px);
            text-align: center;
            padding: 22px 16px 26px;
        }

        h1 {
            margin: 0 0 12px;
            font-size: 20px;
        }

        .wheel-area {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px 0 10px;
        }

        .pointer {
            position: absolute;
            top: 0;
            z-index: 3;
            width: 0;
            height: 0;
            border-left: 14px solid transparent;
            border-right: 14px solid transparent;
            border-bottom: 24px solid #ff3b7a;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, .15));
        }

        canvas {
            width: var(--size);
            height: var(--size);
            border-radius: 50%;
            box-shadow: 0 14px 35px rgba(23, 32, 90, .18);
            background: #fff;
        }

        .btn {
            margin-top: 14px;
            width: min(280px, 90%);
            padding: 12px 14px;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            background: linear-gradient(135deg, #ff3b7a, #ff7a3b);
            color: #fff;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(255, 59, 122, .25);
        }

        .btn:disabled {
            opacity: .55;
            cursor: not-allowed;
        }

        .hint {
            margin: 10px 0 0;
            font-size: 12px;
            color: #666;
        }

        .result {
            margin-top: 14px;
            padding: 12px 14px;
            border-radius: 14px;
            background: rgba(255, 255, 255, .75);
            box-shadow: 0 8px 20px rgba(0, 0, 0, .06);
            display: none;
        }

        .result strong {
            font-size: 16px;
        }

        .small {
            font-size: 12px;
            color: #666;
            margin-top: 6px;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <h1>ğŸ¡ è½¬ç›˜æŠ½å¥–</h1>

        <div class="wheel-area">
            <div class="pointer" aria-hidden="true"></div>
            <canvas id="wheel" width="320" height="320"></canvas>
        </div>

        <button id="spinBtn" class="btn">å¼€å§‹æŠ½å¥–</button>
        <div class="hint">ç‚¹ä¸€æ¬¡æŠ½ä¸€æ¬¡ï¼ˆå¯æŒ‰éœ€æ”¹æˆå¯é‡å¤æŠ½ï¼‰</div>

        <div id="resultBox" class="result">
            <div>ä½ æŠ½åˆ°ï¼š<strong id="resultText"></strong></div>
            <div class="small" id="resultSmall"></div>
        </div>
    </div>

    <script>
        // ===== å¯è‡ªå®šä¹‰å¥–é¡¹ï¼ˆä½ ç»™çš„4ä¸ªï¼‰=====
        const items = [
            "ç¥ç§˜ç¤¼ç‰©",
            "ç­”åº”å¯¹æ–¹ä¸€ä¸ªè¦æ±‚",
            "è·å¾—ç°é‡‘1000",
            "å¯ä»¥æä¸€ä¸ªè¦æ±‚"
        ];

        // ===== è®¾ç½®ï¼šæ˜¯å¦åªèƒ½æŠ½ä¸€æ¬¡ï¼ˆç”¨ localStorage è®°ä½ï¼‰=====
        const ONE_TIME_ONLY = true;
        const STORAGE_KEY = "wheel_spun_once_v1";

        // ===== è½¬ç›˜ç»˜åˆ¶ =====
        const canvas = document.getElementById("wheel");
        const ctx = canvas.getContext("2d");
        const spinBtn = document.getElementById("spinBtn");
        const resultBox = document.getElementById("resultBox");
        const resultText = document.getElementById("resultText");
        const resultSmall = document.getElementById("resultSmall");

        const size = canvas.width;
        const radius = size / 2;
        const center = { x: radius, y: radius };

        // è®©æ–‡å­—æ›´é€‚åˆç§»åŠ¨ç«¯
        function fitFont(text) {
            if (text.length <= 6) return 18;
            if (text.length <= 9) return 16;
            return 14;
        }

        function drawWheel(rotation = 0) {
            ctx.clearRect(0, 0, size, size);

            const n = items.length;
            const anglePer = (Math.PI * 2) / n;

            // èƒŒæ™¯åœˆ
            ctx.save();
            ctx.translate(center.x, center.y);
            ctx.rotate(rotation);

            for (let i = 0; i < n; i++) {
                const start = i * anglePer;
                const end = start + anglePer;

                // æ‰‡å½¢é¢œè‰²ï¼ˆäº¤æ›¿ï¼‰
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, radius - 6, start, end);
                ctx.closePath();
                ctx.fillStyle = i % 2 === 0 ? "#ffe1ec" : "#e8ecff";
                ctx.fill();

                // æ‰‡å½¢è¾¹çº¿
                ctx.strokeStyle = "rgba(0,0,0,.08)";
                ctx.lineWidth = 2;
                ctx.stroke();

                // æ–‡æœ¬
                const mid = (start + end) / 2;
                ctx.save();
                ctx.rotate(mid);
                ctx.textAlign = "right";
                ctx.fillStyle = "#222";
                ctx.font = `600 ${fitFont(items[i])}px -apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",sans-serif`;
                ctx.fillText(items[i], radius - 18, 6);
                ctx.restore();
            }

            // ä¸­å¿ƒåœ†
            ctx.beginPath();
            ctx.arc(0, 0, 42, 0, Math.PI * 2);
            ctx.fillStyle = "#fff";
            ctx.fill();
            ctx.strokeStyle = "rgba(0,0,0,.08)";
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.fillStyle = "#ff3b7a";
            ctx.font = '800 16px -apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",sans-serif';
            ctx.textAlign = "center";
            ctx.fillText("SPIN", 0, 6);

            ctx.restore();
        }

        // ===== æ—‹è½¬åŠ¨ç”» =====
        let rotating = false;
        let currentRotation = 0;

        function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }

        function getRandomIndex() {
            // çº¯éšæœºç­‰æ¦‚ç‡ï¼›å¦‚ä½ è¦åŠ æƒï¼Œæˆ‘ä¹Ÿå¯ä»¥å¸®ä½ æ”¹
            return Math.floor(Math.random() * items.length);
        }

        function spin() {
            if (rotating) return;

            // ä¸€æ¬¡æ€§é™åˆ¶
            if (ONE_TIME_ONLY && localStorage.getItem(STORAGE_KEY) === "1") {
                showResult("ä½ å·²ç»æŠ½è¿‡å•¦ï½", "å¦‚æœæƒ³å…è®¸é‡å¤æŠ½ï¼ŒæŠŠ ONE_TIME_ONLY æ”¹æˆ falseã€‚");
                return;
            }

            rotating = true;
            spinBtn.disabled = true;
            resultBox.style.display = "none";

            const n = items.length;
            const anglePer = (Math.PI * 2) / n;

            // æŒ‡é’ˆåœ¨æ­£ä¸Šæ–¹ï¼ˆ0åº¦æ–¹å‘å¯¹åº” canvas å³ä¾§ï¼Œéœ€è¦æ¢ç®—ï¼‰
            // æˆ‘ä»¬æŠŠâ€œä¸­å¥–æ‰‡å½¢çš„ä¸­å¿ƒâ€è½¬åˆ°æŒ‡é’ˆä½ç½®ï¼ˆæ­£ä¸Šæ–¹ï¼‰ï¼Œæ‰€ä»¥ç›®æ ‡è§’åº¦éœ€è¦å¯¹é½ã€‚
            const winnerIndex = getRandomIndex();
            const winnerCenterAngle = (winnerIndex + 0.5) * anglePer;

            // canvas 0 rad åœ¨å³ä¾§ï¼ŒæŒ‡é’ˆåœ¨ä¸Šæ–¹ = -90Â° = -Math.PI/2
            const pointerAngle = -Math.PI / 2;

            // ç›®æ ‡æ—‹è½¬ï¼šè®© winnerCenterAngle æ—‹åˆ° pointerAngle
            const targetRotationBase = pointerAngle - winnerCenterAngle;

            // å¤šè½¬å‡ åœˆæ›´å¥½çœ‹
            const extraTurns = 5 + Math.floor(Math.random() * 3); // 5~7åœˆ
            const targetRotation = targetRotationBase + extraTurns * Math.PI * 2;

            const startRotation = currentRotation;
            const delta = targetRotation - startRotation;

            const duration = 3600; // ms
            const startTime = performance.now();

            function frame(now) {
                const t = Math.min(1, (now - startTime) / duration);
                const eased = easeOutCubic(t);
                currentRotation = startRotation + delta * eased;
                drawWheel(currentRotation);

                if (t < 1) {
                    requestAnimationFrame(frame);
                } else {
                    rotating = false;
                    spinBtn.disabled = false;

                    // è®°å½•å·²æŠ½
                    if (ONE_TIME_ONLY) localStorage.setItem(STORAGE_KEY, "1");

                    showResult(items[winnerIndex], "æˆªå›¾å‘ç»™å¯¹æ–¹å½“å‡­è¯ä¹Ÿå¯ä»¥ï½");
                }
            }

            requestAnimationFrame(frame);
        }

        function showResult(text, small = "") {
            resultText.textContent = text;
            resultSmall.textContent = small;
            resultBox.style.display = "block";
        }

        spinBtn.addEventListener("click", spin);

        // åˆå§‹ç»˜åˆ¶
        drawWheel(0);

        // åˆå§‹åŒ–â€œä¸€æ¬¡æ€§æŒ‰é’®æ–‡æ¡ˆâ€
        if (ONE_TIME_ONLY && localStorage.getItem(STORAGE_KEY) === "1") {
            spinBtn.textContent = "å·²æŠ½è¿‡ï¼ˆç‚¹æˆ‘æŸ¥çœ‹æç¤ºï¼‰";
        }
    </script>
</body>

</html>