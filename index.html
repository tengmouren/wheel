<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è·¨å¹´ç¤¼ç‰©è½¬ç›˜</title>
  <style>
    :root { --wheel: 320px; }
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",sans-serif;
      background: radial-gradient(circle at top, #fff2f7, #f6f7ff);
      color:#222;
    }
    .wrap{
      width:min(94vw, 880px);
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      padding:18px 14px 22px;
    }
    @media (min-width: 860px){
      .wrap{ grid-template-columns: 420px 1fr; align-items:center; }
    }
    h1{ margin:0; font-size:20px; text-align:center; }
    .left{ display:flex; flex-direction:column; align-items:center; gap:10px; }
    .wheel-area{ position:relative; display:flex; align-items:center; justify-content:center; padding:10px 0; }
    .pointer{
      position:absolute; top:-2px; z-index:3;
      width:0; height:0;
      border-left:14px solid transparent;
      border-right:14px solid transparent;
      border-bottom:24px solid #ff3b7a;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,.15));
    }
    canvas{
      width: var(--wheel);
      height: var(--wheel);
      border-radius:50%;
      box-shadow: 0 14px 35px rgba(23, 32, 90, .18);
      background:#fff;
    }
    .btn{
      width:min(280px, 92%);
      padding:12px 14px;
      border:none;
      border-radius:14px;
      font-size:16px;
      font-weight:700;
      background: linear-gradient(135deg, #ff3b7a, #ff7a3b);
      color:#fff;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(255,59,122,.25);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .hint{ font-size:12px; color:#666; text-align:center; }

    .card{
      background: rgba(255,255,255,.78);
      border:1px solid rgba(0,0,0,.06);
      border-radius:16px;
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
      padding:14px;
    }
    .result-title{ font-size:14px; color:#666; margin:0 0 6px; }
    .result-main{ font-size:20px; font-weight:900; margin:0 0 10px; }
    .result-sub{ font-size:13px; color:#666; margin:0 0 12px; line-height:1.45; }

    .actions{ display:flex; flex-wrap:wrap; gap:10px; }
    .action{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
    }
    .action.primary{
      border:none;
      background: linear-gradient(135deg, #6b6bff, #55d6ff);
      color:#0b1b2a;
    }
    .action.danger{
      border:none;
      background: linear-gradient(135deg, #ff3b7a, #ff7a3b);
      color:#fff;
    }
    .list{
      margin-top:10px;
      font-size:13px;
      color:#333;
      line-height:1.6;
    }
    .list b{ color:#111; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="left">
      <h1>ğŸ¡ è·¨å¹´ç¤¼ç‰©è½¬ç›˜</h1>
      <div class="wheel-area">
        <div class="pointer" aria-hidden="true"></div>
        <canvas id="wheel" width="320" height="320"></canvas>
      </div>
      <button id="spinBtn" class="btn">å¼€å§‹æŠ½å¥–</button>
      <div class="hint">æŠ½åˆ°â€œç­”åº”å¯¹è±¡ä¸€ä¸ªè¦æ±‚â€= å”¯ä¸€æƒ©ç½šé¡¹ç›®ï¼Œä½†æ˜¯å¯å†æŠ½ä¸€æ¬¡ ğŸ˜ˆ</div>
    </div>

    <div class="card">
      <p class="result-title">å¼€å¥–ç»“æœ</p>
      <p class="result-main" id="resultMain">è¿˜æ²¡æŠ½ï½</p>
      <p class="result-sub" id="resultSub">ç‚¹å·¦è¾¹â€œå¼€å§‹æŠ½å¥–â€ï¼Œç»“æœä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œï¼ˆä¸ä¼šå†æŒ¤åœ¨è½¬ç›˜ä¸Šï¼‰ã€‚</p>

      <div class="actions" id="actions"></div>

      <div class="list" id="optionsList"></div>
    </div>
  </div>

<script>
  /**
   * é€‰é¡¹ï¼ˆå†…éƒ¨çœŸå®å†…å®¹ï¼‰
   */
  const options = [
    { id: 1, label: "ç°é‡‘1000", type: "cash", amount: 1000 },
    { id: 2, label: "ç¥ç§˜ç¤¼ç‰©", type: "mystery" },
    { id: 3, label: "å¯ä»¥æä¸€ä¸ªè¦æ±‚", type: "ask" },
    { id: 4, label: "ç°é‡‘500", type: "cash", amount: 500 },
    { id: 5, label: "ç­”åº”å¯¹è±¡ä¸€ä¸ªè¦æ±‚ï¼ˆå”¯ä¸€æƒ©ç½šé¡¹ï¼šå¯å†æŠ½ä¸€æ¬¡ï¼‰", type: "punish" },
    { id: 6, label: "ç°é‡‘1500", type: "cash", amount: 1500 },
    { id: 7, label: "æ´›ä¸½å¡”", type: "gift" },
    { id: 8, label: "åŒ…åŒ…", type: "gift" }
  ];

  /**
   * æ¦‚ç‡æƒé‡ï¼ˆæ€»å’Œ=100ï¼‰
   * - ç°é‡‘1000ï¼š10%
   * - å¯ä»¥æä¸€ä¸ªè¦æ±‚ï¼š10%
   * - å…¶ä½™6é¡¹å‡åˆ†å‰©ä½™80% => æ¯é¡¹ 13.333...%
   * ä½ è¦æ”¹æ¦‚ç‡ï¼Œåªæ”¹è¿™é‡Œå°±è¡Œã€‚
   */
  const weights = new Map([
  [4, 10/3],  // ç°é‡‘500
  [1, 10/3],  // ç°é‡‘1000
  [6, 10/3],  // ç°é‡‘1500

  [2, 18],    // ç¥ç§˜ç¤¼ç‰©
  [3, 18],    // å¯ä»¥æä¸€ä¸ªè¦æ±‚
  [5, 18],    // æƒ©ç½šï¼šç­”åº”å¯¹è±¡ä¸€ä¸ªè¦æ±‚
  [7, 18],    // æ´›ä¸½å¡”
  [8, 18],    // åŒ…åŒ…
  ]);

  /**
   * æ˜¯å¦é™åˆ¶åªèƒ½æŠ½ä¸€æ¬¡ï¼ˆé»˜è®¤ä¸é™åˆ¶ï¼Œæ›´é€‚åˆæš§æ˜§äº’åŠ¨ï¼‰
   * å¦‚æœä½ æƒ³â€œæ¯ä¸ªè®¾å¤‡åªèƒ½æŠ½ä¸€æ¬¡â€ï¼Œæ”¹æˆ true
   */
  const ONE_TIME_ONLY = false;
  const STORAGE_KEY = "newyear_wheel_spun_v1";

  // ===== UI å…ƒç´  =====
  const canvas = document.getElementById("wheel");
  const ctx = canvas.getContext("2d");
  const spinBtn = document.getElementById("spinBtn");
  const resultMain = document.getElementById("resultMain");
  const resultSub = document.getElementById("resultSub");
  const actions = document.getElementById("actions");
  const optionsList = document.getElementById("optionsList");

  const size = canvas.width;
  const radius = size / 2;
  const center = { x: radius, y: radius };

  // è½¬ç›˜ä¸Šåªæ˜¾ç¤ºçŸ­æ–‡å­—ï¼Œé¿å…å­—ä½“æ˜¾ç¤ºä¸å…¨ï¼šè¿™é‡Œç”¨â€œ1~8â€
  const wheelShortTexts = options.map(o => String(o.id));

  function drawWheel(rotation = 0) {
    ctx.clearRect(0, 0, size, size);

    const n = options.length;
    const anglePer = (Math.PI * 2) / n;

    ctx.save();
    ctx.translate(center.x, center.y);
    ctx.rotate(rotation);

    for (let i = 0; i < n; i++) {
      const start = i * anglePer;
      const end = start + anglePer;

      // æ‰‡å½¢
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.arc(0, 0, radius - 6, start, end);
      ctx.closePath();
      ctx.fillStyle = i % 2 === 0 ? "#ffe1ec" : "#e8ecff";
      ctx.fill();

      ctx.strokeStyle = "rgba(0,0,0,.08)";
      ctx.lineWidth = 2;
      ctx.stroke();

      // çŸ­æ–‡æœ¬ï¼ˆ1~8ï¼‰
      const mid = (start + end) / 2;
      ctx.save();
      ctx.rotate(mid);
      ctx.textAlign = "right";
      ctx.fillStyle = "#222";
      ctx.font = '900 22px -apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",sans-serif';
      ctx.fillText(wheelShortTexts[i], radius - 18, 8);
      ctx.restore();
    }

    // ä¸­å¿ƒ
    ctx.beginPath();
    ctx.arc(0, 0, 44, 0, Math.PI * 2);
    ctx.fillStyle = "#fff";
    ctx.fill();
    ctx.strokeStyle = "rgba(0,0,0,.08)";
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.fillStyle = "#ff3b7a";
    ctx.font = '900 16px -apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",sans-serif';
    ctx.textAlign = "center";
    ctx.fillText("SPIN", 0, 6);

    ctx.restore();
  }

  function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

  function weightedPick() {
    const list = options.map(o => ({ opt: o, w: weights.get(o.id) ?? 0 }));
    const total = list.reduce((s, x) => s + x.w, 0);
    const r = Math.random() * total;
    let acc = 0;
    for (const x of list) {
      acc += x.w;
      if (r <= acc) return x.opt;
    }
    return list[list.length - 1].opt; // fallback
  }

  function clearActions() {
    actions.innerHTML = "";
  }

  function addAction(text, cls, onClick) {
    const btn = document.createElement("button");
    btn.className = "action " + (cls || "");
    btn.textContent = text;
    btn.addEventListener("click", onClick);
    actions.appendChild(btn);
  }

  function showResult(opt, { pendingCashChoice = false } = {}) {
    clearActions();

    if (typeof opt === "string") {
      resultMain.textContent = opt;
      resultSub.textContent = "";
      return;
    }

    resultMain.textContent = `ä½ æŠ½åˆ°ï¼š${opt.label}`;
    // é»˜è®¤å‰¯æ–‡æ¡ˆ
    resultSub.textContent = "ï¼ˆè¦ä¸â€¦â€¦æˆªå›¾å‘æˆ‘ï¼Ÿæˆ‘çœ‹çœ‹ä½ æœ‰æ²¡æœ‰ä½œå¼Š ğŸ˜ï¼‰";

    // ç°é‡‘ï¼šç»™é€‰æ‹©æç¤º
    if (opt.type === "cash") {
      resultSub.textContent = "ç°é‡‘å¥–åŠ±æ¥äº†ï½ä½ é€‰ï¼šç°åœ¨æ‹¿ç°é‡‘ï¼Œè¿˜æ˜¯æ¢æˆã€Œç¥ç§˜ç¤¼ç‰©ã€ï¼Ÿ";
      addAction("ç°åœ¨æ‹¿ç°é‡‘ âœ…", "primary", () => {
        resultMain.textContent = `ç¡®è®¤ï¼šç°é‡‘${opt.amount}`;
        resultSub.textContent = "å¥½ï½é‚£æˆ‘è®°è´¦äº†ï¼ˆè½¬è´¦/çº¢åŒ…ç”±ä½ ä»¬è‡ªå·±çº¦å®šå‘æ”¾æ–¹å¼ï¼‰";
        clearActions();
      });
      addAction("æ¢æˆç¥ç§˜ç¤¼ç‰© ğŸ", "danger", () => {
        const mystery = options.find(o => o.type === "mystery");
        resultMain.textContent = `ä½ é€‰æ‹©äº†ï¼š${mystery.label}`;
        resultSub.textContent = "ç¥ç§˜ç¤¼ç‰©å·²é”å®šï½æƒ³è¦çš„è¯ï¼Œå°±æ¥æ‰¾æˆ‘é¢† ğŸ˜Œ";
        clearActions();
      });
      return;
    }

    // æƒ©ç½šï¼šå¯å†æŠ½ä¸€æ¬¡
    if (opt.type === "punish") {
      resultSub.textContent = "æƒ©ç½šé€‰é¡¹ï¼šç­”åº”å¯¹æ–¹ä¸€ä¸ªè¦æ±‚ï¼ˆä¸è¿‡ä½ å¯ä»¥å†æŠ½ä¸€æ¬¡æ¥â€œç¿»ç›˜â€ï¼‰";
      addAction("å†æŠ½ä¸€æ¬¡ ğŸ”", "danger", () => spin(true));
      return;
    }
  }

  // æ—‹è½¬åŠ¨ç”»ï¼šæŠ½åˆ°å“ªä¸ªå°±åœåˆ°å“ªä¸ª
  let rotating = false;
  let currentRotation = 0;

  function spin(isBonusSpin = false) {
    if (rotating) return;

    if (ONE_TIME_ONLY && !isBonusSpin && localStorage.getItem(STORAGE_KEY) === "1") {
      showResult("ä½ å·²ç»æŠ½è¿‡å•¦ï½");
      resultSub.textContent = "å¦‚æœæƒ³å…è®¸é‡å¤æŠ½ï¼ŒæŠŠ ONE_TIME_ONLY æ”¹æˆ falseã€‚";
      return;
    }

    rotating = true;
    spinBtn.disabled = true;
    clearActions();

    const winner = weightedPick();
    const n = options.length;
    const anglePer = (Math.PI * 2) / n;

    // winner åœ¨æ•°ç»„é‡Œçš„ç´¢å¼•
    const winnerIndex = options.findIndex(o => o.id === winner.id);

    // è®©è¯¥æ‰‡å½¢ä¸­å¿ƒå¯¹é½æŒ‡é’ˆï¼ˆä¸Šæ–¹ï¼‰
    const winnerCenterAngle = (winnerIndex + 0.5) * anglePer;
    const pointerAngle = -Math.PI / 2;
    const targetRotationBase = pointerAngle - winnerCenterAngle;

    const extraTurns = 5 + Math.floor(Math.random() * 3);
    const targetRotation = targetRotationBase + extraTurns * Math.PI * 2;

    const startRotation = currentRotation;
    const delta = targetRotation - startRotation;

    const duration = 3600;
    const startTime = performance.now();

    function frame(now) {
      const t = Math.min(1, (now - startTime) / duration);
      const eased = easeOutCubic(t);
      currentRotation = startRotation + delta * eased;
      drawWheel(currentRotation);

      if (t < 1) {
        requestAnimationFrame(frame);
      } else {
        rotating = false;
        spinBtn.disabled = false;

        // åªæœ‰éâ€œå¥–åŠ±å†æŠ½â€æ‰è®°ä¸€æ¬¡
        if (ONE_TIME_ONLY && !isBonusSpin) localStorage.setItem(STORAGE_KEY, "1");

        showResult(winner);

        // å¦‚æœ ONE_TIME_ONLY å¼€å¯ä¸”æŠ½å®Œï¼ŒæŒ‰é’®æ–‡æ¡ˆå˜ä¸€ä¸‹
        if (ONE_TIME_ONLY && localStorage.getItem(STORAGE_KEY) === "1") {
          spinBtn.textContent = "å·²æŠ½è¿‡ï¼ˆç‚¹æˆ‘æŸ¥çœ‹æç¤ºï¼‰";
        }
      }
    }
    requestAnimationFrame(frame);
  }

  spinBtn.addEventListener("click", () => spin(false));

  // åˆå§‹ç»˜åˆ¶
  drawWheel(0);

  // å³ä¾§å±•ç¤ºâ€œç¼–å·å¯¹åº”å¥–å“â€
  optionsList.innerHTML = `
    <div><b>ç¼–å·å¯¹åº”å¥–å“ï¼š</b></div>
    ${options.map(o => `ã€${o.id}ã€‘${o.label}`).join("<br/>")}
    <div style="margin-top:10px;color:#666;">
     
    </div>
  `;
</script>
</body>
</html>


